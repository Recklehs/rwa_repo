-- Partitioning candidate set (staging/experiment use).
-- This script creates partitioned shadow tables in schema `experiment_perf`.
-- Existing production tables are left untouched.

CREATE SCHEMA IF NOT EXISTS experiment_perf;

CREATE TABLE IF NOT EXISTS experiment_perf.processed_events_hash (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  event_key TEXT NOT NULL,
  block_number BIGINT NOT NULL,
  tx_hash TEXT NOT NULL,
  payload JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
) PARTITION BY HASH (event_key);

DO $$
DECLARE
  i INT;
  partition_name TEXT;
BEGIN
  FOR i IN 0..15 LOOP
    partition_name := format('processed_events_hash_p%02s', i);
    EXECUTE format(
      'CREATE TABLE IF NOT EXISTS experiment_perf.%I PARTITION OF experiment_perf.processed_events_hash FOR VALUES WITH (MODULUS 16, REMAINDER %s)',
      partition_name,
      i
    );
  END LOOP;
END
$$;

CREATE UNIQUE INDEX IF NOT EXISTS uq_exp_processed_events_hash_event_key
  ON experiment_perf.processed_events_hash (event_key);

CREATE INDEX IF NOT EXISTS idx_exp_processed_events_hash_block_number
  ON experiment_perf.processed_events_hash (block_number);

CREATE INDEX IF NOT EXISTS idx_exp_processed_events_hash_tx_hash
  ON experiment_perf.processed_events_hash (tx_hash);

INSERT INTO experiment_perf.processed_events_hash(event_key, block_number, tx_hash, payload, created_at)
SELECT event_key, block_number, tx_hash, payload, created_at
FROM public.processed_events
ON CONFLICT (event_key) DO NOTHING;

CREATE TABLE IF NOT EXISTS experiment_perf.trades_hash (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  listing_id BIGINT NOT NULL,
  buyer TEXT NOT NULL,
  seller TEXT NOT NULL,
  tx_hash TEXT NOT NULL,
  traded_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  amount NUMERIC
) PARTITION BY HASH (tx_hash);

DO $$
DECLARE
  i INT;
  partition_name TEXT;
BEGIN
  FOR i IN 0..15 LOOP
    partition_name := format('trades_hash_p%02s', i);
    EXECUTE format(
      'CREATE TABLE IF NOT EXISTS experiment_perf.%I PARTITION OF experiment_perf.trades_hash FOR VALUES WITH (MODULUS 16, REMAINDER %s)',
      partition_name,
      i
    );
  END LOOP;
END
$$;

CREATE UNIQUE INDEX IF NOT EXISTS uq_exp_trades_hash_tx_hash
  ON experiment_perf.trades_hash (tx_hash);

CREATE INDEX IF NOT EXISTS idx_exp_trades_hash_listing_id
  ON experiment_perf.trades_hash (listing_id);

CREATE INDEX IF NOT EXISTS idx_exp_trades_hash_traded_at
  ON experiment_perf.trades_hash (traded_at DESC);

INSERT INTO experiment_perf.trades_hash(listing_id, buyer, seller, tx_hash, traded_at, amount)
SELECT listing_id, buyer, seller, tx_hash, traded_at, amount
FROM public.trades
ON CONFLICT (tx_hash) DO NOTHING;

ANALYZE experiment_perf.processed_events_hash;
ANALYZE experiment_perf.trades_hash;
